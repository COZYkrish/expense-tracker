{% extends "base_dashboard.html" %}

{% block content %}
<h1>Loan Applications</h1>

<div class="card">
    <table>
        <thead>
            <tr>
                <th>User</th>
                <th>Amount</th>
                <th>Tenure</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>

        <tbody>
            {% for loan in loans %}
            <tr id="loan-{{ loan.id }}">
                <td>{{ loan.borrower }}</td>
                <td>₹{{ loan.amount }}</td>
                <td>{{ loan.tenure }} months</td>
                <td>
                    <span class="status {{ loan.status }}">
                        {{ loan.status }}
                    </span>
                </td>
                <td>
                    {% if loan.status == "Pending" %}
                    <button class="btn approve"
                            data-loan-id="{{ loan.id }}"
                            onclick="updateStatus(this, 'Approved')">
                        Approve
                    </button>

                    <button class="btn reject"
                            data-loan-id="{{ loan.id }}"
                            onclick="updateStatus(this, 'Rejected')">
                        Reject
                    </button>
                    {% else %}
                        —
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function updateStatus(button, status) {
    const loanId = button.dataset.loanId;

    fetch(`/admin/update-status/${loanId}/${status}`, {
        method: "POST"
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const row = document.getElementById(`loan-${loanId}`);
            const badge = row.querySelector(".status");

            badge.innerText = status;
            badge.className = `status ${status}`;

            row.querySelector("td:last-child").innerHTML = "—";

            row.classList.add("pulse");
            setTimeout(() => row.classList.remove("pulse"), 600);
        }
    });
}
</script>
{% endblock %}
